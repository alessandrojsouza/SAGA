<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" lang="pt-br">

        <script type="text/javascript">

            function controleEletrovalvulaBomba() {
                valorAtual = document.getElementById('eletrovalvula_bomba').getAttribute("value");
                valorBomba = document.getElementById('bomba').getAttribute("value");               
                const xhttp = new XMLHttpRequest();

                if (valorAtual == "fechada") {
                    xhttp.open("GET", "http://192.168.0.109/LED1=ON");
                    xhttp.send();
                    document.getElementById('luz1').style.fill = "#00FF21";
                    document.getElementById('eletrovalvula_bomba').setAttribute("value", "aberta");  
                    
                } else {
                    if (valorBomba == "desligado") {
                        xhttp.open("GET", "http://192.168.0.109/LED1=OFF");
                        xhttp.send();
                        document.getElementById('luz1').style.fill = "#FFFA8D";
                        document.getElementById('eletrovalvula_bomba').setAttribute("value", "fechada");
                    } else {
                        window.alert("Desligue a bomba antes de fechar a válvula")
                    }
                    
                }

            }

            function controleEletrovalvulaDreno() {
                valorAtual = document.getElementById('eletrovalvula_dreno').getAttribute("value");                
                const xhttp = new XMLHttpRequest();

                if (valorAtual == "fechada") {
                    xhttp.open("GET", "http://192.168.0.109/LED2=ON");
                    xhttp.send();
                    document.getElementById('luz2').style.fill = "#00FF21";
                    document.getElementById('eletrovalvula_dreno').setAttribute("value", "aberta");
                    
                    
                } else {
                    xhttp.open("GET", "http://192.168.0.109/LED2=OFF");
                    xhttp.send();
                    document.getElementById('luz2').style.fill = "#FFFA8D";
                    document.getElementById('eletrovalvula_dreno').setAttribute("value", "fechada");
                }
            }

            function lerSensorFluxoBomba() {
                setInterval(
                    function() { 
                        valorBomba = document.getElementById('bomba').getAttribute("value");
                        valorValvulaBomba = document.getElementById('eletrovalvula_bomba').getAttribute("value");
                        if (valorBomba == "ligado" && valorValvulaBomba == "aberta") {
                            const xhttp = new XMLHttpRequest();
                            xhttp.onload = function() { document.getElementById("textoSensBomba").innerHTML = this.responseText + " l/min"; }
                            xhttp.open("GET", "http://esptest.local/recebevazao.php");
                            xhttp.send();
                        }
                    }, 500);

            }

            function lerSensorFluxoDreno() {
                setInterval(
                    function() { 
                        valorValvulaDreno = document.getElementById('eletrovalvula_dreno').getAttribute("value");
                        if (valorValvulaDreno == "aberta") {
                            const xhttp = new XMLHttpRequest();
                            xhttp.onload = function() { document.getElementById("textoSensDreno").innerHTML = this.responseText + " l/min"; }
                            xhttp.open("GET", "http://esptest.local/recebevazao.php");
                            xhttp.send();
                        }
                    }, 500);

            }

            function controlarBomba() {
                valor = document.getElementById("bomba").getAttribute("value");
                valorValvulaBomba = document.getElementById("eletrovalvula_bomba").getAttribute("value");

                if (valor == "desligado") {
                    if (valorValvulaBomba == "aberta"){
                        document.getElementById("bomba").style.fill = "#00FF21";
                        document.getElementById("bomba").setAttribute("value", "ligado");
                    } else {
                        window.alert("Abra a válvula antes de ligar a bomba")
                    }
                        
                }

                if (valor == "ligado") {
                    document.getElementById("bomba").style.fill = "red";
                    document.getElementById("bomba").setAttribute("value", "desligado");
                }
            }

            window.onload=function(){
                lerSensorFluxoBomba();
                lerSensorFluxoDreno();
            }
        </script>

        <style>
            #canvas {
                display: flex;
                justify-content: center;
            }

            #eletrovalvula_bomba:hover, #eletrovalvula_dreno:hover, #bomba:hover {
                cursor: pointer;
            }
        </style>
    </head>

    <body>
        <section id="canvas">
        
            <svg width="800" height="800" xmlns="http://www.w3.org/2000/svg">

                <g>
                <!-- TANQUES -->
                <rect id="poco" height="170" width="125" y="498.20001" x="314.50001" stroke="#000" fill="none"/>
                <rect id="cisterna" height="170" width="125" y="74.2" x="310" stroke="#000" fill="none"/>

                <!-- DUTO DA BOMBA -->
                <rect stroke="null" class="duto_bomba" height="14" width="121" y="647.2" x="424" fill="#FFB27C"/>
                <rect stroke="null" class="duto_bomba" height="620.99995" width="14" y="40.00005" x="539.66667" fill="#FFB27C"/>
                <rect stroke="null" class="duto_bomba" height="14" width="135.00001" y="40.2" x="414" fill="#FFB27C"/>
                <rect stroke="null" class="duto_bomba" height="174" width="14" y="51.99999" x="413.66667" fill="#FFB27C"/>
                
                <!-- DUTO DE DRENAGEM -->
                <rect stroke="null" class="duto_dreno" height="14" width="42" y="227.2" x="290" fill="#FFB27C"/>
                <rect stroke="null" class="duto_dreno" height="197" width="14" y="235.99999" x="289.66667" fill="#FFB27C"/>
                <rect stroke="null" class="duto_dreno" height="14" width="75" y="419.2" x="295" fill="#FFB27C"/>
                <rect stroke="null" class="duto_dreno" height="99" width="14" y="418.99997" x="369.66667" fill="#FFB27C"/>
                
                <!-- BOMBA -->
                <rect onclick="controlarBomba()" id="bomba" height="33" width="53" y="635.2" x="456" stroke="#000" fill="red" value="desligado"/>
                
                <!-- ELETROVÁLVULAS -->
                <g onclick="controleEletrovalvulaBomba()" id="eletrovalvula_bomba" value="fechada">
                    <title>Eletroválvula do duto da bomba</title>
                    <rect stroke="null" id="eletroRect1" height="50.65441" width="24" y="272.4" x="535.2" fill="#666666"/>
                    <rect stroke="null" id="luz1" height="28" width="22" y="284.4" x="559.2" fill="#FFFA8D"/>
                </g>
                <g onclick="controleEletrovalvulaDreno()" id="eletrovalvula_dreno" value="fechada">
                    <title>Eletroválvula do duto de drenagem</title>
                    <rect stroke="null" id="eletrorect2" height="50.65441" width="24" y="271.4" x="284.2" fill="#666666"/>
                    <rect stroke="null" id="luz2" height="28" width="22" y="283.4" x="308.2" fill="#FFFA8D"/>
                </g>
                
                <!-- CANOS DOS SENSORES DE NÍVEL -->
                <rect stroke="null" id="canoSensDoPoco" height="171" width="7" y="493" x="317.66668" fill="#FFB27C"/>
                <rect stroke="null" id="canoSensDaCisterna" height="153" width="7" y="67" x="313.66668" fill="#FFB27C"/>

                <!-- SENSORES DE NÍVEL -->
                <g stroke="null" id="svg_29">
                <rect stroke="null" id="svg_26" height="3.20945" width="17.85929" y="506.00011" x="324.7" fill="#000000"/>
                <rect stroke="null" transform="matrix(0.570157 0.271173 -0.335325 0.461078 313.394 177.485)" id="svg_28" height="6" width="17.3664" y="506.9714" x="348.6029" fill="#000000"/>
                </g>
                <g stroke="null" id="svg_32">
                <rect stroke="null" id="svg_30" height="3.20945" width="17.85929" y="655.99848" x="324.7" fill="#000000"/>
                <rect stroke="null" transform="matrix(0.570157 0.271173 -0.335325 0.461078 313.394 177.485)" id="svg_31" height="6" width="17.3664" y="748.68504" x="490.76134" fill="#000000"/>
                </g>
                <g stroke="null" id="svg_35">
                <rect stroke="null" id="svg_33" height="3.20945" width="17.85929" y="216.66994" x="320.03339" fill="#000000"/>
                <rect stroke="null" transform="matrix(0.570157 0.271173 -0.335325 0.461078 313.394 177.485)" id="svg_34" height="6" width="17.3664" y="44.30926" x="68.31378" fill="#000000"/>
                </g>
                <g stroke="null" id="svg_38">
                <rect stroke="null" id="svg_36" height="3.20945" width="17.85929" y="149.33733" x="320.70005" fill="#000000"/>
                <rect stroke="null" transform="matrix(0.570157 0.271173 -0.335325 0.461078 313.394 177.485)" id="svg_37" height="6" width="17.3664" y="-64.70427" x="5.36918" fill="#000000"/>
                </g>
                <g stroke="null" id="svg_41">
                <rect stroke="null" id="svg_39" height="3.20945" width="17.85929" y="117.33768" x="320.70005" fill="#000000"/>
                <rect stroke="null" transform="matrix(0.570157 0.271173 -0.335325 0.461078 313.394 177.485)" id="svg_40" height="6" width="17.3664" y="-116.26983" x="-24.95794" fill="#000000"/>
                </g>
                <g stroke="null" id="svg_44">
                <rect stroke="null" id="svg_42" height="3.20945" width="17.85929" y="80.00475" x="320.70005" fill="#000000"/>
                <rect stroke="null" transform="matrix(0.570157 0.271173 -0.335325 0.461078 313.394 177.485)" id="svg_43" height="6" width="17.3664" y="-176.42968" x="-60.3396" fill="#000000"/>
                </g>
                <g stroke="null" id="svg_47">
                <rect stroke="null" id="svg_45" height="3.20945" width="17.85929" y="184.67028" x="320.70004" fill="#000000"/>
                <rect stroke="null" transform="matrix(0.570157 0.271173 -0.335325 0.461078 313.394 177.485)" id="svg_46" height="6" width="17.3664" y="-7.76727" x="38.85539" fill="#000000"/>
                </g>

                <!-- SENSORES DE FLUXO -->
                <text y="355" x="320" fill="black" id="textoSensDreno"></text>
                <g class="sensorFluxo_dreno">
                    <title>Sensor de fluxo do duto de drenagem</title>
                    <ellipse ry="19.99978" rx="19.99978" id="sensLuz1" cy="381.72482" cx="312.65891" stroke="null" fill="#729C62"/>
                    <rect stroke="null" id="sensRect1" height="50.65441" width="24" y="356.06575" x="284.2" fill="#666666"/>
                </g>

                <text y="385" x="580" fill="black" id="textoSensBomba"></text>
                <g class="sensorFluxo_bomba">
                    <title>Sensor de fluxo do duto da bomba</title>
                    <ellipse ry="19.99978" rx="19.99978" id="sensLuz2" cy="413.72448" cx="563.32285" stroke="null" fill="#729C62"/>
                    <rect stroke="null" id="sensRect2" height="50.65441" width="24" y="388.0654" x="534.86394" fill="#666666"/>
                </g>
                </g>
            </svg>
        </section>
    </body>
</html>